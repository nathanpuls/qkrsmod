<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Recently Updated Pages</title>
    <style>
        body {
            font-family: 'Poppins', Arial, sans-serif;
            background: #f8f9fb;
            color: #222;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 480px;
            margin: 2.5em auto 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 16px 0 rgba(0, 0, 0, 0.07);
            padding: 2em 1.5em 1.5em 1.5em;
        }

        h1 {
            font-size: 1.7em;
            font-weight: 600;
            margin: 0 0 1.2em 0;
            letter-spacing: -1px;
            text-align: center;
        }

        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        li {
            margin-bottom: 1.2em;
            padding: 0.7em 1em;
            border-radius: 8px;
            background: #f3f6fa;
            display: flex;
            flex-direction: column;
            transition: background 0.2s;
        }

        li:hover {
            background: #e9eef5;
        }

        .recent-link {
            color: Black;
            font-size: 1.1em;
            font-weight: 500;
            text-decoration: underline;
            margin-bottom: 0.2em;
            word-break: break-all;
            transition: color 0.2s;
        }

    

        .timestamp {
            color: #888;
            font-size: 0.92em;
            margin-left: 2px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Recently Updated Pages</h1>
        <ul id="recent-list">
            <li>Loading...</li>
        </ul>
    </div>
    <script type="module">
        import { db } from '../../js/firebase.js';
        import { ref, get, child } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        async function loadRecentNotes() {
            const list = document.getElementById('recent-list');
            // Helper: recursively collect leaf notes with their full path
            function collectLeafNotes(obj, path = []) {
                let notes = [];
                for (const [key, value] of Object.entries(obj)) {
                    if (typeof value === 'string') {
                        // String value: treat as leaf note
                        notes.push({
                            name: [...path, key].join('/'),
                            updatedAt: undefined
                        });
                    } else if (value && typeof value === 'object' && Object.keys(value).length > 0) {
                        // If value has any non-object or empty-object children, treat as leaf
                        const isLeaf = Object.values(value).every(
                            v => typeof v !== 'object' || v === null || Object.keys(v).length === 0
                        );
                        if (isLeaf) {
                            notes.push({
                                name: [...path, key].join('/'),
                                updatedAt: value.updatedAt
                            });
                        } else {
                            notes = notes.concat(collectLeafNotes(value, [...path, key]));
                        }
                    } else {
                        // Primitive value or empty object, treat as leaf
                        notes.push({
                            name: [...path, key].join('/'),
                            updatedAt: value && value.updatedAt
                        });
                    }
                }
                return notes;
            }
            try {
                const dbRef = ref(db);
                const snapshot = await get(child(dbRef, 'notes'));
                list.innerHTML = '';
                if (!snapshot.exists()) {
                    list.innerHTML = '<li>No recent updates found.</li>';
                    return;
                }
                // Recursively collect leaf notes
                let notesArr = collectLeafNotes(snapshot.val());
                // Only include notes with a valid updatedAt timestamp
                notesArr = notesArr.filter(note => typeof note.updatedAt === 'number' && note.updatedAt > 0);
                notesArr.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                if (notesArr.length === 0) {
                    list.innerHTML = '<li>No recently updated notes found.</li>';
                    return;
                }
                notesArr.slice(0, 20).forEach(note => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a class="recent-link" href="../../${encodeURIComponent(note.name)}">${note.name}</a>
                        <div class="timestamp">${new Date(note.updatedAt).toLocaleString()}</div>
                    `;
                    list.appendChild(li);
                });
            } catch (err) {
                list.innerHTML = `<li>Error loading updates: ${err.message}</li>`;
            }
        }

        loadRecentNotes();
    </script>
</body>

</html>