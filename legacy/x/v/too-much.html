<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>qk.rs · View</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/bold/style.css">

<style>
:root {
  --white: #ffffff;
  --black: #111111;
  --primary: #4e4e4e;
  --light-gray: #ccc;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: 'Poppins', sans-serif;
  background: var(--white);
  color: var(--black);
  overflow: hidden;
}

#viewer {
  height: calc(100vh - 60px);
  overflow-y: auto;
  padding: 20px;
  font-size: 24px;
  line-height: 1.6;
  white-space: pre-wrap;
  box-sizing: border-box;
}

.line {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
  gap: 8px;
}

.line a {
  color: var(--primary);
  text-decoration: underline;
  word-break: break-all;
  flex: 1;
}

.copy-line-btn {
  font-size: 20px;
  background: none;
  border: none;
  color: var(--primary);
  cursor: pointer;
}

.copy-line-btn:hover {
  opacity: 0.7;
}

#bottomBar {
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 60px;
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: var(--white);
  border-top: 1px solid #eee;
  z-index: 1000;
}

#bottomBar button {
  cursor: pointer;
  background: none;
  border: none;
  font-size: 22px;
  color: var(--primary);
}

#bottomBar img {
  height: 28px;
}
</style>
</head>
<body>

<div id="viewer">Loading…</div>

<div id="bottomBar">
  <button id="copyBtn"><i class="ph-bold ph-copy-simple"></i> Copy All</button>
  <button id="copyLinkBtn"><i class="ph-bold ph-link-simple-horizontal"></i> Copy Link to Page</button>
  <button id="arrowBtn"><i class="ph-bold ph-arrow-right"></i> Go to Link/Google</button>
  <button id="backBtn">Back</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // -----------------------------
  // Firebase setup
  // -----------------------------
  firebase.initializeApp({
    apiKey: "AIzaSyDFP5GAwTNqLyaySh_t_2j8NFiulHTeFy8",
    authDomain: "fwdng-1d5f9.firebaseapp.com",
    databaseURL: "https://fwdng-1d5f9.firebaseio.com",
    projectId: "fwdng-1d5f9",
    storageBucket: "fwdng-1d5f9.firebasestorage.app",
    messagingSenderId: "250477002363",
    appId: "1:250477002363:web:95a89409c8d5991a9aacde"
  });

  const db = firebase.database();
  const viewer = document.getElementById("viewer");

  function normalizePath(path) {
    return path
      .toLowerCase()
      .replace(/^\/+/, "")
      .replace(/\/+$/, "")
      .replace(/[.#$[\]]/g, "");
  }

  function linkify(text) {
    text = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    const regex = /(\bhttps?:\/\/[^\s<]+)|(\bwww\.[^\s<]+)|(\b(?:\d{1,3}\.){3}\d{1,3}(?::\d+)?(?:\/[^\s<]*)?)|(\b(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(?:\/[^\s<]*)?)|([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})|(\+?\d[\d\s().-]{7,}\d)/g;
    return text.replace(regex, (match, p1, p2, p3, p4, p5, p6) => {
      if (p1) return `<a href="${p1}" target="_blank" rel="noopener">${p1}</a>`;
      if (p2) return `<a href="https://${p2}" target="_blank" rel="noopener">${p2}</a>`;
      if (p3) return `<a href="http://${p3}" target="_blank" rel="noopener">${p3}</a>`;
      if (p4) return `<a href="https://${p4}" target="_blank" rel="noopener">${p4}</a>`;
      if (p5) return `<a href="mailto:${p5}">${p5}</a>`;
      if (p6) return `<a href="tel:${p6}">${p6}</a>`;
      return match;
    });
  }

  function renderViewer(text) {
    viewer.innerHTML = text.split("\n").map(line => {
      return `<div class="line"><button class="copy-line-btn"><i class="ph-bold ph-copy-simple"></i></button><span>${linkify(line)}</span></div>`;
    }).join("");

    document.querySelectorAll('.copy-line-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const lineEl = e.target.closest('.line');
        const lineText = lineEl.innerText.trim();
        navigator.clipboard.writeText(lineText).then(() => {
          const icon = btn.querySelector('i');
          if(icon) icon.className = 'ph-bold ph-check';
          setTimeout(() => icon.className = 'ph-bold ph-copy-simple', 800);
        });
      });
    });
  }

  // -----------------------------
  // Read query param
  // -----------------------------
  const params = new URLSearchParams(window.location.search);
  const rawT = params.get("t");

  if (!rawT) {
    viewer.innerHTML = "No content specified.";
    throw new Error("Missing ?t parameter");
  }

  const t = normalizePath(rawT);
  document.title = t.split("/").pop() + " · View";

  // -----------------------------
  // Firebase read-only listener
  // -----------------------------
  const ref = db.ref("notes/" + t);
  ref.on("value", snap => {
    const val = snap.val() || "";
    renderViewer(val);
  });

  // -----------------------------
  // Bottom Bar Logic
  // -----------------------------
  const copyBtn = document.getElementById("copyBtn");
  copyBtn.addEventListener("click", () => {
    const content = viewer.innerText;
    navigator.clipboard.writeText(content).then(() => {
      copyBtn.innerHTML = '<i class="ph-bold ph-check"></i>';
      setTimeout(() => copyBtn.innerHTML = '<i class="ph-bold ph-copy-simple"></i>', 900);
    });
  });

  const copyLinkBtn = document.getElementById("copyLinkBtn");
  copyLinkBtn.addEventListener("click", () => {
    navigator.clipboard.writeText(window.location.href).then(() => {
      copyLinkBtn.innerHTML = '<i class="ph-bold ph-check"></i>';
      setTimeout(() => copyLinkBtn.innerHTML = '<i class="ph-bold ph-link-simple-horizontal"></i>', 900);
    });
  });

  const arrowBtn = document.getElementById("arrowBtn");
  arrowBtn.addEventListener("click", () => {
    const query = viewer.innerText.trim();
    if (!query) return;
    const isURL = /^(https?:\/\/)?([\w-]+\.)+[\w-]{2,}(\/[^\s]*)?(\?[^\s]*)?(#[^\s]*)?$/.test(query);
    window.location.href = isURL ? (query.startsWith("http") ? query : "http://" + query) : "https://www.google.com/search?q=" + encodeURIComponent(query);
  });

  // -----------------------------
  // Back button
  // -----------------------------
  const backBtn = document.getElementById("backBtn");
  backBtn.addEventListener("click", () => {
    window.location.href = "/" + t; // Navigate to qk.rs/<t>
  });

</script>
</body>
</html>
